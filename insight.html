<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loading... | Only True Perspective</title>
  
  <!-- SEO / Social (Dynamic via JS, but defaults here) -->
  <meta property="og:type" content="article" />
  <link rel="stylesheet" href="./styles.css?v=2.6" />
  <link rel="stylesheet" href="./blog-enhancements.css" />
  <style>body { margin: 0 !important; }</style>
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Outfit:wght@400;700;800&family=Syne:wght@700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet" />
  
  <style>
      /* Blog Specific Styles */
      .blog-container {
          max-width: 800px;
          margin: 160px auto 100px;
          padding: 0 20px;
      }
      .blog-header {
          text-align: center;
          margin-bottom: 60px;
          overflow: visible;
      }
      .blog-meta {
          color: var(--muted);
          font-family: 'Space Grotesk', sans-serif;
          font-size: 0.9rem;
          margin-bottom: 20px;
          text-transform: uppercase;
          letter-spacing: 1px;
      }
      .blog-title {
          font-family: 'Outfit', sans-serif;
          font-size: clamp(2.5rem, 8vw, 4rem);
          line-height: 1.1;
          color: var(--text);
          margin-bottom: 40px;
          font-weight: 800;
          overflow: visible !important;
          display: block;
      }
      .blog-content {
          font-family: 'Inter', sans-serif;
          font-size: 1.1rem;
          line-height: 1.8;
          color: var(--muted);
      }
      .blog-content p { margin-bottom: 24px; }
      .blog-content h2 { 
          color: var(--text); 
          margin-top: 50px; 
          margin-bottom: 20px; 
          font-family: 'Outfit', sans-serif;
          line-height: 1.3;
          font-weight: 700;
      }
      .blog-content ul { margin-bottom: 24px; padding-left: 20px; }
      .blog-content li { margin-bottom: 10px; }
      
      .back-link {
          display: inline-block;
          margin-bottom: 40px;
          color: var(--accent);
          text-decoration: none;
          font-family: 'Space Grotesk', sans-serif;
          opacity: 0.7;
          transition: opacity 0.3s;
      }
      .back-link:hover { opacity: 1; }

      /* Loading State */
      .loader {
          text-align: center;
          margin-top: 200px;
          font-family: 'Space Grotesk', sans-serif;
          color: var(--accent2);
          animation: pulse 1.5s infinite;
      }
      @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
  </style>
</head>
<body class="insight-post-page">
  <div class="bg-fixed"></div>

  <header class="nav nav-split">
    <a href="index.html" class="nav-logo" aria-label="OTP">
      <img src="assets/otp_v2.png" alt="OTP" class="otp-mark" />
    </a>
    <nav class="nav-links">
      <a href="index.html#work" class="k-hover">Work</a>
      <a href="archive.html" class="k-hover">Archive</a>
      <a href="insights.html" class="active k-hover">Insights</a>
      <a href="index.html#services" class="k-hover">Services</a>
      <a href="index.html#contact" class="k-hover">Contact</a>
    </nav>
    <button class="nav-toggle"><span></span><span></span><span></span></button>
    <nav class="nav-drawer" aria-label="Mobile">
      <a href="index.html#work">Work</a>
      <a href="archive.html">Archive</a>
      <a href="insights.html">Insights</a>
      <a href="index.html#services">Services</a>
      <a href="index.html#contact">Contact</a>
    </nav>
  </header>

  <main>
      <div id="loader" class="loader">DECODING SIGNAL...</div>

      <div id="content" class="blog-container" style="display: none; opacity: 0;">
          <a href="insights.html" class="back-link">← Back to Insights</a>
          
          <!-- Hero Image -->
          <div id="heroImageContainer" class="blog-hero-wrap" style="display:none;">
              <img id="postHeroImage" class="blog-hero-img" src="" alt="Hero Visual">
          </div>

          <header class="blog-header">
              <div id="postMeta" class="blog-meta"></div>
              <h1 id="postTitle" class="blog-title"></h1>
          </header>
          
          <article id="postBody" class="blog-content">
              <!-- Content injected here -->
          </article>
      </div>
  </main>

  <footer class="footer">
    <div class="wrap footer-inner">
      <div class="footer-left">
        <div class="fineprint">© <span id="year"></span> OTP.</div>
      </div>
    </div>
  </footer>

  <canvas id="cursor-canvas"></canvas>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/kursor"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="site-config.js"></script>
  <script src="site-init.js"></script>
  
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
        const loader = document.getElementById('loader');
        const content = document.getElementById('content');

        // 1. Parse URL Parameter
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('slug');

        if (!slug) {
            window.location.href = 'insights.html';
            return;
        }

        // 2. SUPABASE FETCH (Using centralized config)
        const SUPABASE_URL = window.OTP_CONFIG ? window.OTP_CONFIG.supabaseUrl : null;
        const SUPABASE_KEY = window.OTP_CONFIG ? window.OTP_CONFIG.supabaseKey : null;
        
        const setStatus = (msg, isError = false) => {
            if (loader) {
                loader.innerHTML = `<div style="color: ${isError ? '#ff4444' : 'var(--accent2)'}; padding: 20px;">${msg}</div>`;
                if(isError) loader.style.animation = 'none';
            }
        };

        try {
            // Check if library is loaded
            if (typeof window.supabase === 'undefined') {
                throw new Error("Database Library Offline.");
            }

            if (!SUPABASE_URL || !SUPABASE_KEY) {
                throw new Error("Missing database credentials.");
            }

            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            // Set a timeout for the fetch
            const fetchPromise = supabase
                .from('posts')
                .select('*')
                .eq('slug', slug)
                .single();

            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error("Connection Timeout")), 8000)
            );

            const { data, error } = await Promise.race([fetchPromise, timeoutPromise]);

            if (error || !data) {
                setStatus(`TRANSMISSION NOT FOUND. <br><a href="insights.html" style="color: var(--accent2); text-decoration: none; font-size: 0.9rem; margin-top: 20px; display: inline-block;">← Return to Insights</a>`, true);
                return;
            }

            // 3. Render Content & SEO
            document.title = `${data.title} | OTP Insights`;
            
            // TRACK VIEW (Unique)
            if (window.OTP && window.OTP.trackView) {
                window.OTP.trackView(slug);
            }
            
            // Update Meta Description
            let metaDesc = document.querySelector('meta[name="description"]');
            if (!metaDesc) {
                metaDesc = document.createElement('meta');
                metaDesc.name = 'description';
                document.head.appendChild(metaDesc);
            }
            metaDesc.content = data.excerpt || (data.content ? data.content.substring(0, 150).replace(/<[^>]*>/g, '') : '');
            
            // Update OG Title
            let ogTitle = document.querySelector('meta[property="og:title"]');
            if (ogTitle) ogTitle.content = data.title;
            
            const date = new Date(data.created_at).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            document.getElementById('postMeta').textContent = `${date} • INSIGHT`;
            document.getElementById('postTitle').textContent = data.title;

            // Hero Media Logic
            if (data.image_url) {
                const heroWrap = document.getElementById('heroImageContainer');
                const url = data.image_url;
                
                heroWrap.innerHTML = '';
                
                if (url.match(/\.(mp4|webm)$/i)) {
                    heroWrap.innerHTML = `<video class="blog-hero-video" src="${url}" autoplay muted loop playsinline controls></video>`;
                } else if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    let videoId = url.split('v=')[1] || url.split('/').pop();
                    const ampersandPosition = videoId.indexOf('&');
                    if (ampersandPosition !== -1) videoId = videoId.substring(0, ampersandPosition);
                    heroWrap.innerHTML = `<div class="media-container" style="margin:0;"><iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1" frameborder="0" allowfullscreen></iframe></div>`;
                } else {
                    const img = document.createElement('img');
                    img.className = 'blog-hero-img';
                    img.src = url;
                    img.alt = data.title;
                    heroWrap.appendChild(img);
                }
                heroWrap.style.display = 'block';
            }
            
            // 4. RENDER BODY
            const isHTML = data.content.trim().startsWith('<');
            let formattedContent = data.content;
            
            if (!isHTML) {
                formattedContent = data.content
                    .split('\n\n')
                    .map(p => `<p>${p}</p>`)
                    .join('')
                    .replace(/\n/g, '<br/>');
            }

            document.getElementById('postBody').innerHTML = formattedContent;

            // 5. Reveal
            if (loader) loader.style.display = 'none';
            if (content) {
                content.style.display = 'block';
                if (typeof gsap !== 'undefined') {
                    gsap.to(content, { opacity: 1, duration: 1, ease: 'power2.out' });
                    gsap.from('.blog-title', { y: 20, opacity: 0, duration: 0.8, delay: 0.2 });
                } else {
                    content.style.opacity = '1';
                }
            }

        } catch (e) {
            console.error(e);
            setStatus(`SIGNAL INTERRUPTED: ${e.message}`, true);
        }
    });
  </script>

    // Year update
  </script>

  <script src="stars-v2.js"></script>
</body>
</html>
