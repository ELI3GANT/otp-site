<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OTP Pocket Command</title>
  <link rel="stylesheet" href="./styles.css?v=2.6" />
  <link rel="stylesheet" href="./admin-styles.css" />
  <script src="./admin-init.js" defer></script>
  <style>body { margin: 0 !important; font-family: 'Space Grotesk', sans-serif; background: var(--bg); color: var(--text); }</style>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet" />
  
    <style>
  
        :root {
  
            --accent: #7000ff;
  
            --accent2: #00c3ff;
  
            --bg: #030305;
  
            --card: rgba(255, 255, 255, 0.04);
  
            --stroke: rgba(255, 255, 255, 0.1);
  
            --success: #00ffaa;
  
        }
  
  
  
        body { 
  
            margin: 0 !important; 
  
            font-family: 'Inter', sans-serif; 
  
            background: var(--bg); 
  
            color: var(--text); 
  
            -webkit-font-smoothing: antialiased;
  
            padding-bottom: 50px;
  
        }

        [data-theme="light"] {
            --bg: #f5f5f7;
            --text: #1d1d1f;
            --card: #ffffff;
            --stroke: #d2d2d7;
            --accent: #6200e0;
            --accent2: #0071e3;
            --success: #28cd41;
        }

        [data-theme="light"] input, 
        [data-theme="light"] textarea, 
        [data-theme="light"] select {
            background: #fff;
            color: #1d1d1f;
            border-color: #d2d2d7;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }

        [data-theme="light"] .admin-header {
            background: rgba(255,255,255,0.8);
            border-bottom: 1px solid #d2d2d7;
        }

        [data-theme="light"] .toggle-wrap {
            background: #fff;
            border-color: #d2d2d7;
        }

        [data-theme="light"] .ai-tips {
            background: #fdfdff;
            border: 1px solid #d2d2d7; /* Soft border */
            box-shadow: 0 10px 30px rgba(0,0,0,0.03);
        }

        [data-theme="light"] .preset-btn {
            background: #fff;
            color: #555;
            border: 1px solid #d2d2d7;
        }

        [data-theme="light"] .preset-btn:hover {
            border-color: #6200e0;
            color: #6200e0;
            background: #f8f5ff;
        }

        [data-theme="light"] .ai-tips h4 { color: #1d1d1f; }
        [data-theme="light"] .section-label { color: #6200e0; }
        [data-theme="light"] .btn-secondary { color: #555; border-color: #d2d2d7; }
        [data-theme="light"] .btn-secondary:hover { background: #f5f5f7; color: #000; }
        [data-theme="light"] .toggle-label { color: #1d1d1f; }
        [data-theme="light"] .input-group label { color: #444; }
  
  
  
        .admin-header {
  
            position: sticky;
  
            top: 0;
  
            background: rgba(3, 3, 5, 0.95);
  
            backdrop-filter: blur(20px);
  
            -webkit-backdrop-filter: blur(20px);
  
            padding: 15px 20px;
  
            border-bottom: 1px solid var(--stroke);
  
            z-index: 100;
  
            display: flex;
  
            justify-content: space-between;
  
            align-items: center;
  
        }
  
  
  
        .admin-header h1 { 
  
            margin: 0; 
  
            font-size: 1.1rem;
  
            letter-spacing: 2px;
  
            font-family: 'Space Grotesk', sans-serif;
  
            color: var(--accent2);
  
            text-transform: uppercase;
  
        }
  
  
  
        .admin-wrap {
  
            max-width: 800px; /* Widen for more controls */
  
            margin: 0 auto;
  
            padding: 20px;
  
            padding-bottom: 120px;
  
        }
  
        
  
        .section-label {
  
            font-family: 'Space Grotesk', sans-serif;
  
            font-size: 0.75rem;
  
            font-weight: 800;
  
            color: var(--accent);
  
            text-transform: uppercase;
  
            letter-spacing: 2px;
  
            margin: 30px 0 15px;
  
            display: flex;
  
            align-items: center;
  
            gap: 15px;
  
        }
  
        .section-label::after {
  
            content: "";
  
            flex: 1;
  
            height: 1px;
  
            background: linear-gradient(90deg, var(--accent), transparent);
  
            opacity: 0.3;
  
        }
  
  
  
        .input-group { margin-bottom: 20px; position: relative; }
  
        
  
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
  
        @media (max-width: 600px) { .row { grid-template-columns: 1fr; } }
  
  
  
        label { 
  
            display: block; 
  
            margin-bottom: 8px; 
  
            font-weight: 700; 
  
            color: #888; 
  
            font-size: 0.75rem; 
  
            text-transform: uppercase;
  
            letter-spacing: 0.5px;
  
        }
  
        .desc { font-size: 0.75rem; color: #555; margin-bottom: 10px; display: block; line-height: 1.4; }
  
        
  
        input, textarea, select {
  
            width: 100%;
  
            background: rgba(255,255,255,0.03);
  
            border: 1px solid var(--stroke);
  
            color: #fff;
  
            padding: 14px;
  
            border-radius: 8px;
  
            font-family: inherit;
  
            font-size: 0.95rem;
  
            transition: all 0.2s ease;
  
        }
  
        input:focus, textarea:focus, select:focus { 
  
            border-color: var(--accent2); 
  
            background: rgba(255,255,255,0.06);
  
            outline: none; 
  
            box-shadow: 0 0 15px rgba(0, 195, 255, 0.1);
  
        }
  
        textarea { height: 120px; line-height: 1.6; resize: vertical; }
  
        
  
        /* Toggle Switch */
  
        .toggle-wrap { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px; border: 1px solid var(--stroke); }
  
        .toggle-label { margin: 0; color: #ccc; }
  
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
  
        .switch input { opacity: 0; width: 0; height: 0; }
  
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
  
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  
        input:checked + .slider { background-color: var(--success); }
  
        input:checked + .slider:before { transform: translateX(20px); }
  
  
  
        /* AI Panel */
  
        .ai-tips {
  
            background: linear-gradient(135deg, rgba(112, 0, 255, 0.08), rgba(0, 0, 0, 0.4));
  
            padding: 20px;
  
            border-radius: 12px;
  
            border: 1px solid rgba(112, 0, 255, 0.3);
  
            margin: 30px 0;
  
            position: relative;
  
        }
  
        .ai-tips h4 { margin: 0 0 10px 0; color: #fff; font-family: 'Space Grotesk', sans-serif; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
  
        
  
        button {
  
            width: 100%;
  
            padding: 16px;
  
            background: var(--accent2);
  
            color: #000;
  
            border: none;
  
            font-weight: 800;
  
            border-radius: 10px;
  
            font-size: 1rem;
  
            font-family: 'Space Grotesk', sans-serif;
  
            cursor: pointer;
  
            text-transform: uppercase;
  
            letter-spacing: 1px;
  
            transition: all 0.2s ease;
  
            box-shadow: 0 5px 20px rgba(0, 195, 255, 0.15);
  
        }
  
        button:active { transform: scale(0.98); opacity: 0.9; }
  
        
  
        .btn-secondary {
  
            background: transparent;
  
            border: 1px solid var(--stroke);
  
            color: #888;
  
            box-shadow: none;
  
            font-size: 0.8rem;
  
            padding: 10px;
  
        }
  
        .btn-secondary:hover { border-color: #fff; color: #fff; }
  
  
  
        /* TOAST NOTIFICATION */
  
        .toast {
  
            position: fixed;
  
            top: 20px;
        /* GATEKEEPER STYLES */
        .gatekeeper {
            position: fixed;
            inset: 0;
            background: #030305;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 24px;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }
        .gate-blur {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, var(--accent) 0%, transparent 60%);
            opacity: 0.15;
            filter: blur(80px);
        }
        .gate-content {
            position: relative;
            z-index: 2;
            text-align: center;
            width: 100%;
            max-width: 320px;
            padding: 20px;
        }
        .gate-input {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--stroke);
            padding: 16px;
            border-radius: 12px;
            color: #fff;
            text-align: center;
            font-size: 1.2rem;
            letter-spacing: 4px;
            margin-bottom: 15px;
            outline: none;
            transition: all 0.3s ease;
        }
        .gate-input:focus {
            border-color: var(--accent2);
            box-shadow: 0 0 20px rgba(0, 195, 255, 0.2);
        }
        .gate-btn {
            width: 100%;
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 1px;
            transition: transform 0.2s ease;
        }
        .gate-btn:active { transform: scale(0.98); }
        .gatekeeper.unlocked {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        body.locked { overflow: hidden; }

        /* STATUS INDICATORS */
        .status-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            color: #aaa;
            border: 1px solid var(--stroke);
            text-transform: uppercase;
            letter-spacing: 1px;
            backdrop-filter: blur(5px);
        }
        [data-theme="light"] .status-pill {
            background: #fff;
            border-color: #d2d2d7;
            color: #555;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #444;
            transition: all 0.3s ease;
        }
        .status-dot.active {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
            animation: pulse-green 2s infinite;
        }
        .status-pill.active {
            border-color: rgba(0, 255, 170, 0.4);
            color: #fff;
            background: rgba(0, 255, 170, 0.05);
        }
        [data-theme="light"] .status-pill.active {
            background: rgba(40, 205, 65, 0.1);
            border-color: var(--success);
            color: #111;
        }
        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 255, 170, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(0, 255, 170, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 255, 170, 0); }
        }

        .checkmark-circle {
  
            width: 24px; height: 24px;
  
            background: var(--success);
  
            border-radius: 50%;
  
            display: grid;
  
            place-items: center;
  
            color: #000;
  
            font-size: 14px;
  
        }
  
  
  
        /* Image Preview */
  
        #imagePreview {
  
            width: 100%;
  
            height: 240px;
  
            border-radius: 12px;
  
            background-size: cover;
  
            background-position: center;
  
            margin-bottom: 15px;
  
            display: none;
  
            border: 1px solid var(--stroke);
  
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  
        }
  
  
  
    </style>
  
  </head>
  
  <body class="locked">
    <!-- GATEKEEPER OVERLAY -->
    <div id="gate" class="gatekeeper">
        <div class="gate-blur"></div>
        <div class="gate-content">
            <h1 style="color: var(--accent2); font-size: 1rem; margin-bottom: 25px; letter-spacing: 2px;">ENCRYPTED CHANNEL <span id="gateCheck" style="display:none; color: var(--success); margin-left: 10px;">âœ“</span></h1>
            <input type="password" id="gatePass" class="gate-input" placeholder="â€¢â€¢â€¢â€¢" maxlength="8">
            <button onclick="unlockChannel()" class="gate-btn">ESTABLISH CONNECTION</button>
            <p id="gateError" style="color: #ff4444; font-size: 0.8rem; margin-top: 15px; display: none;">ACCESS DENIED: INVALID SIGNAL</p>
        </div>
    </div>
  
  
  
    <!-- TOAST -->
  
    <div id="toast" class="toast">
  
        <div class="checkmark-circle">âœ“</div>
  
        <span>POST PUBLISHED SUCCESSFULLY</span>
  
    </div>
  
  
  
    <header class="admin-header" id="adminHeader">
        <h1>OTP COMMAND</h1>
        <div style="font-size: 0.7rem; color: #666; font-family: monospace;">V3.2 LIVE NETWORK</div>
        <div class="nav-links" style="margin-left: auto;"></div>
    </header>
  
  
  
    <div class="admin-wrap">
  
        
  
        <form id="postForm">
  
            
  
            <!-- ACCESS -->
  
            
  
            <!-- SECTION: MEDIA -->
  
            <div class="section-label">01 // Visual Intelligence</div>
  
            <div class="input-group">
  
                <div id="imagePreview" style="display:none; border-radius: 12px; overflow: hidden; border: 1px solid var(--stroke); margin-bottom: 15px;">
                    <img id="previewImg" src="" alt="Preview" style="width: 100%; height: auto; display: block; max-height: 400px; object-fit: cover;">
                </div>
                <!-- File Details Container -->
                <div id="fileDetails" style="display: none; padding: 10px; border: 1px dashed var(--stroke); border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; color: #888;">
                    <span id="fileNameDisplay"></span> <span id="fileSizeDisplay" style="color: var(--accent);"></span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn-secondary" onclick="document.getElementById('fileInput').click()">Upload File</button>
                    <input type="file" id="fileInput" accept="image/*" style="display: none">
                    <input type="text" id="urlInput" placeholder="Or Paste URL..." style="border: 1px solid var(--stroke); background: transparent;">
                </div>
                <input type="hidden" name="image_url" id="imageUrl">
  
            </div>
  
  
  
            <!-- SECTION: CORE DATA -->
  
            <div class="section-label">02 // Core Data</div>
  
            
  
            <div class="input-group">
  
                <label>Headline</label>
  
                <input type="text" name="title" id="titleInput" placeholder="The Death of 1080p" required>
  
            </div>
  
  
  
            <div class="row">
  
                <div class="input-group">
  
                    <label>Slug</label>
  
                    <input type="text" name="slug" id="slugInput" placeholder="auto-generated" style="color: var(--accent2);">
  
                </div>
  
                <div class="input-group">
  
                    <label>Category</label>
  
                    <select name="category" id="catInput">
  
                        <option value="Strategy">Strategy</option>
  
                        <option value="Tech">Tech</option>
  
                        <option value="Production">Production</option>
  
                        <option value="Case Study">Case Study</option>
  
                    </select>
  
                </div>
  
            </div>
  
  
  
            <div class="row">
                <div class="input-group">
                    <label>Author</label>
                    <input type="text" name="author" value="OTP Admin">
                </div>
            </div>
            <!-- Removed Duplicate Presets Block -->

        <div class="wrap" style="padding: 10px; display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
           <div class="status-pill k-hover"><div class="status-dot" id="dbStatusDot"></div> DB LINKED</div>
           <div class="status-pill k-hover"><div class="status-dot" id="uploadStatusDot"></div> MEDIA SYNC</div>
           <div class="status-pill k-hover"><div class="status-dot" id="aiStatusDot"></div> AI GHOST</div>
        </div>
  
            <!-- AI BRAIN -->
  
            <div class="ai-tips">
  
                <h4>ðŸ¤– NEURAL GENERATOR V3</h4>
  
                <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 15px;">Fills Content, SEO, and Metadata automatically.</p>
  
                
  
                <div class="input-group">
  
                    <input type="password" id="apiKey" placeholder="OpenAI API Key (sk-...)" onchange="localStorage.setItem('openai_key', this.value)" style="background: rgba(0,0,0,0.3);">
  
                </div>
  
                
  
                <div class="input-group">
                     <label>Post Archetype (Presets)</label>
                     <select id="archetype" style="background: rgba(0,0,0,0.2); font-weight: bold; color: var(--accent2);">
                         <option value="technical">Technical Breakdown (Edgy, Deep)</option>
                         <option value="launch">Visual Launch (Hype, Fast)</option>
                         <option value="strategy">Business Strategy (Professional, ROI focused)</option>
                         <option value="case-study">Case Study (Data driven, Results)</option>
                     </select>
                </div>

                <div class="row">
  
                    <div class="input-group">
  
                         <label>Core Concept / Prompt</label>
  
                         <textarea id="aiPrompt" placeholder="What is this about? (e.g. Testing the Sony A7SIII in low light Rhode Island rain)" style="height: 60px;"></textarea>
  
                    </div>
  
                    <button type="button" id="magicBtn" style="height: 100%; margin-top: 23px; background: linear-gradient(135deg, #7000ff, #ff00ff); color: white;">âš¡ TRANSMIT TO AI (FULL AUTO)</button>
  
                </div>
  
                <div id="aiStatus" style="font-size: 0.75rem; color: var(--accent2); margin-top: 10px; min-height: 15px;"></div>
  
            </div>
  
  
  
            <!-- SECTION: CONTENT -->
  
            <div class="section-label">03 // The Meat</div>
  
            
  
            <div class="input-group">
  
                <label>Excerpt (Card Summary)</label>
  
                <textarea name="excerpt" id="excerptInput" style="height: 80px;" required placeholder="The short sequence that appears on the feed grid..."></textarea>
  
            </div>
  
  
  
            <div class="input-group">
  
                <label>Full Content (Markdown/HTML)</label>
  
                <textarea name="content" id="contentArea" style="height: 400px; font-family: monospace; font-size: 0.9rem;" required placeholder="Paste your article here or use the generator above..."></textarea>
  
            </div>
  
  
  
            <!-- SECTION: SEO & ANALYTICS -->
  
            <div class="section-label">04 // Visibility Controls</div>
  
            
  
            <div class="input-group">
  
                <label>SEO Meta Title</label>
  
                <input type="text" name="seo_title" id="seoTitle" placeholder="Google optimized title">
  
            </div>
  
            
  
            <div class="input-group">
  
                <label>SEO Meta Description</label>
  
                <textarea name="seo_desc" id="seoDesc" style="height: 80px;" placeholder="Snippet for search results..."></textarea>
  
            </div>
  
  
  
            <div class="row">
  
               <div class="input-group">
  
                   <label>Initial Views</label>
  
                   <input type="number" name="views" value="441" placeholder="Initial traffic seed">
  
               </div>
  
               <div class="toggle-wrap">
  
                   <span class="toggle-label">Live Status</span>
  
                   <label class="switch">
  
                     <input type="checkbox" name="published" id="pubToggle" checked>
  
                     <span class="slider"></span>
  
                   </label>
  
               </div>
  
            </div>
  
  
  
            <div style="height: 30px;"></div>
  
            
  
            <button type="submit" id="submitBtn" style="height: 70px; font-size: 1.2rem; margin-bottom: 20px; background: var(--success); color: #000;">COMMENCE BROADCAST</button>
  
            
  
            <div style="text-align: center;">
  
                <button type="button" class="btn-secondary" onclick="copySchema()" style="width: auto; opacity: 0.5;">ðŸ“‹ Copy DB Upgrade SQL</button>
  
            </div>
  
  
  
        </form>
  
    </div>
  
    
  
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      // 1. SUPABASE INITIALIZATION
      const SUPABASE_URL = 'https://ckumhowhucbbmpdeqkrl.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrdW1ob3dodWNiYm1wZGVxa3JsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NzQ3NjcsImexCI6MjA4MzQ1MDc2N30.yIJ1diGLWjtLWm8P2D5flF2nd0xPKn_8x2RR3DlIrag';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // 2. DOM ELEMENTS
      const postForm = document.getElementById('postForm');
      const submitBtn = document.getElementById('submitBtn');
      const titleInput = document.getElementById('titleInput');
      const slugInput = document.getElementById('slugInput');
      const urlInput = document.getElementById('urlInput');
      const imagePreview = document.getElementById('imagePreview');
      const imageUrlHidden = document.getElementById('imageUrl');
      const aiStatus = document.getElementById('aiStatus');
      const magicBtn = document.getElementById('magicBtn');
      const toast = document.getElementById('toast');

      // 2.5 AUTO-INIT (Mobile Power: Key & Pass from URL)
      const urlParams = new URLSearchParams(window.location.search);
      
      // Auto-Key
      if (urlParams.has('key')) {
          localStorage.setItem('openai_key', urlParams.get('key'));
      }
      
      // Auto-Unlock (Passcode bypass for Mobile Bookmarks)
      if (urlParams.get('pass') === 'otp2026') {
          // Unlocks immediately
          document.body.classList.remove('locked');
          const gate = document.getElementById('gate');
          if(gate) gate.classList.add('unlocked');
          showToast("SECURE CHANNEL OPENED");
          // Clean URL
          window.history.replaceState({}, document.title, window.location.pathname);
      }

      // PRE-FILL API KEY 
      const savedKey = localStorage.getItem('openai_key');
      if(savedKey) {
          document.getElementById('apiKey').value = savedKey;
      }

      // 3. UTILITIES
      function showToast(text) {
          if(text) toast.querySelector('span').textContent = text;
          toast.classList.add('show');
          setTimeout(() => toast.classList.remove('show'), 3000);
      }

      function updateStatusDots() {
          const dbPill = document.getElementById('dbStatusDot').parentElement;
          const mediaPill = document.getElementById('uploadStatusDot').parentElement;
          const aiPill = document.getElementById('aiStatusDot').parentElement;

          if(window.supabase) {
              document.getElementById('dbStatusDot').classList.add('active');
              dbPill.classList.add('active');
          }

          if(imageUrlHidden && imageUrlHidden.value) {
              document.getElementById('uploadStatusDot').classList.add('active');
              mediaPill.classList.add('active');
          } else {
              document.getElementById('uploadStatusDot').classList.remove('active');
              mediaPill.classList.remove('active');
          }

          if(document.getElementById('contentArea').value) {
              document.getElementById('aiStatusDot').classList.add('active');
              aiPill.classList.add('active');
          } else {
              document.getElementById('aiStatusDot').classList.remove('active');
              aiPill.classList.remove('active');
          }
      }
      setInterval(updateStatusDots, 1500);

      function generateSlug(title) {
          const slug = title.toLowerCase()
              .replace(/[^\w\s-]/g, '')
              .trim()
              .replace(/\s+/g, '-')
              .replace(/-+/g, '-');
          if(slugInput) slugInput.value = slug;
      }

      function unlockChannel() {
          const val = document.getElementById('gatePass').value;
          if(val === 'otp2026') {
              document.getElementById('gate').classList.add('unlocked');
              document.body.classList.remove('locked');
              showToast("CONNECTION ESTABLISHED");
          } else {
              const err = document.getElementById('gateError');
              err.style.display = 'block';
              document.getElementById('gatePass').value = '';
          }
      }

      // Allow Enter Key for Gatekeeper
      document.getElementById('gatePass').addEventListener('keypress', (e) => {
          if(e.key === 'Enter') unlockChannel();
      });

      // 4. PREVIEW LOGIC
      urlInput.addEventListener('input', (e) => {
          const url = e.target.value;
          if(url && url.startsWith('http')) {
              imagePreview.style.backgroundImage = `url(${url})`;
              imagePreview.style.display = 'block';
              imageUrlHidden.value = url;
          }
      });

      // Hook up title input to slug generation
      titleInput.addEventListener('input', (e) => {
          generateSlug(e.target.value);
      });

      // 5. STYLE PRESETS LOGIC
      let currentStyle = 'cinematic';
      document.querySelectorAll('.preset-btn').forEach(btn => {
          btn.addEventListener('click', () => {
              document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              currentStyle = btn.dataset.style;
          });
      });

      // 6. AI GHOSTWRITER LOGIC
      async function triggerAIGenerator() {
          const promptContext = document.getElementById('aiPrompt').value;
          const title = titleInput.value;
          const key = document.getElementById('apiKey').value;
          const archetype = document.getElementById('archetype').value;

          if(!key || !title || !promptContext) { 
              aiStatus.textContent = "ERROR: Key, Title, and Prompt required.";
              aiStatus.style.color = "#ff4444";
              return; 
          }

          magicBtn.textContent = "SYNTHESIZING...";
          magicBtn.disabled = true;
          document.getElementById('aiStatusDot').classList.add('active');
          aiStatus.textContent = "TRANSMITTING TO NEURAL CORE...";
          aiStatus.style.color = "var(--accent2)";

          const styleContext = {
              cinematic: "High-end production, color grading, and polished sequences.",
              guerilla: "Fast-paced, raw, authentic, and high-energy.",
              technical: "Equipment details, camera settings, and precision.",
              strategy: "ROI, business growth, and brand positioning."
          };

          const systemPrompt = `You are the Lead Creative Director and Head of Strategy for OTP (Only True Perspective). 
          Your writing style is edgy, high-end, and deeply technical yet accessible to visionaries. 
          Style Preset: ${styleContext[currentStyle]}. 
          Archetype: ${archetype}. 
          Return ONLY a JSON object: { "content": "A comprehensive, high-value HTML string including structured <h2> and <p> tags. Write a complete, ready-to-publish article.", "excerpt": "One punchy sentence that hooks the reader instantly.", "seo_title": "Optimized SEO Title", "seo_desc": "Engaging Search Description", "category": "Tech, Strategy, or Production" }`;
          
          const userPrompt = `Generate a world-class, viral post titled: "${title}". 
          Context/Focus: ${promptContext}. 
          Requirements: Use bold industry insights, a visionary tone, and structured HTML layout. Make it a complete, full-length insight.`;

          try {
              const res = await fetch('https://api.openai.com/v1/chat/completions', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                  body: JSON.stringify({
                      model: "gpt-4-turbo",
                      messages: [
                          { role: "system", content: systemPrompt },
                          { role: "user", content: userPrompt }
                      ],
                      temperature: 0.8,
                      response_format: { type: "json_object" }
                  })
              });

              const data = await res.json();
              if(data.error) throw new Error(data.error.message);
              
              const result = JSON.parse(data.choices[0].message.content);
              
              document.getElementById('contentArea').value = result.content;
              document.getElementById('excerptInput').value = result.excerpt;
              document.getElementById('seoTitle').value = result.seo_title;
              document.getElementById('seoDesc').value = result.seo_desc;
              document.getElementById('catInput').value = result.category || 'Tech';
              
              // NEW: Auto-generate slug from the AI-provided SEO title
              if (result.seo_title) generateSlug(result.seo_title);
              
              aiStatus.textContent = "INTEL RECEIVED. SYNC COMPLETE.";
              aiStatus.style.color = "var(--success)";
          } catch(e) {
              console.error(e);
              aiStatus.textContent = "SIGNAL LOST: " + e.message;
              aiStatus.style.color = "#ff4444";
          } finally {
              magicBtn.textContent = "âš¡ TRANSMIT TO AI (FULL AUTO)";
              magicBtn.disabled = false;
              document.getElementById('aiStatusDot').classList.remove('active');
          }
      }

      magicBtn.addEventListener('click', triggerAIGenerator);

      // 7. FILE UPLOAD LOGIC
      document.getElementById('fileInput').addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if(!file) return;

          // IMMEDIATE LOCAL PREVIEW
          const reader = new FileReader();
          reader.onload = function(e) {
              const previewBox = document.getElementById('imagePreview');
              const previewImg = document.getElementById('previewImg');
              previewImg.src = e.target.result;
              previewBox.style.display = 'block';
          }
          reader.readAsDataURL(file);

          // SHOW PREVIEW DETAILS
          const fileDetails = document.getElementById('fileDetails');
          const fileNameDisplay = document.getElementById('fileNameDisplay');
          const fileSizeDisplay = document.getElementById('fileSizeDisplay');
          
          if(fileDetails) {
              fileDetails.style.display = 'block';
              fileNameDisplay.textContent = file.name;
              fileSizeDisplay.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
          }

          document.getElementById('uploadStatusDot').classList.add('active');
          aiStatus.textContent = "INITIALIZING SECURE UPLOAD...";

          try {
              const fileName = `blog/${Date.now()}_${file.name}`;
              const { data, error } = await supabase.storage.from('uploads').upload(fileName, file);
              if (error) throw error;

              const { data: { publicUrl } } = supabase.storage.from('uploads').getPublicUrl(fileName);
              
              imageUrlHidden.value = publicUrl;
              aiStatus.textContent = "MEDIA UPLOADED & LOCKED.";
              aiStatus.style.color = "var(--success)";
          } catch (err) {
              console.error(err);
              aiStatus.textContent = "UPLOAD FAIL: " + err.message; 
              // Note: We don't alert here to avoid blocking UI, but we log it.
          } finally {
              document.getElementById('uploadStatusDot').classList.remove('active');
          }
      });

      // 8. FORM SUBMISSION
      postForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const originalText = submitBtn.textContent;
          submitBtn.textContent = "BROADCASTING...";
          submitBtn.disabled = true;

          const formData = new FormData(postForm);
          const newPost = {
              title: formData.get('title'),
              slug: formData.get('slug'),
              image_url: imageUrlHidden.value || formData.get('image_url'),
              excerpt: formData.get('excerpt'),
              content: formData.get('content'),
              published: document.getElementById('pubToggle').checked,
              category: formData.get('category'),
              author: formData.get('author'),
              seo_title: formData.get('seo_title'),
              seo_desc: formData.get('seo_desc'),
              views: parseInt(formData.get('views') || 0),
              created_at: new Date().toISOString()
          };

          try {
              const { error } = await supabase.from('posts').insert([newPost]);
              if(error) throw error;

              showToast("POST BROADCAST SUCCESSFULLY");
              setTimeout(() => {
                  if(confirm("Post is Live. View Transmission?")) {
                      window.location.href = `insight.html?slug=${newPost.slug}`;
                  }
                  submitBtn.textContent = originalText;
                  submitBtn.disabled = false;
              }, 1000);
          } catch (err) {
              console.error(err);
              alert("CRITICAL ERROR: " + err.message);
              submitBtn.textContent = originalText;
              submitBtn.disabled = false;
          }
      });

      function unlockChannel() {
          const val = document.getElementById('gatePass').value;
          if(val === 'otp2026') {
              document.getElementById('gateCheck').style.display = 'inline';
              showToast("CONNECTION ESTABLISHED");
              setTimeout(() => {
                  document.getElementById('gate').classList.add('unlocked');
                  document.body.classList.remove('locked');
              }, 800);
          } else {
              const err = document.getElementById('gateError');
              err.style.display = 'block';
              document.getElementById('gatePass').value = '';
          }
      }

      function copySchema() {
          const sql = `
          alter table posts 
          add column if not exists category text,
          add column if not exists author text default 'OTP Admin',
          add column if not exists seo_title text,
          add column if not exists seo_desc text,
          add column if not exists views int8 default 0;
          `;
          navigator.clipboard.writeText(sql);
          alert("Neural Schema Copied! Run in Supabase SQL Editor.");
      }

      // INITIAL CONNECTION CHECK
      async function checkConnection() {
          try {
              const { count, error } = await supabase.from('posts').select('*', { count: 'exact', head: true });
              if(error) throw error;
              document.getElementById('dbStatusDot').classList.add('active');
              showToast("SYSTEM ONLINE");
          } catch(e) {
              console.error("Connection Check Failed:", e);
              // Retry once
              setTimeout(() => {
                  console.log("Retrying connection...");
                  checkConnection(); 
              }, 2000);
          }
      }

      // Run check on load
      checkConnection();
    </script>
    <script src="site-init.js"></script>
  </body>
</html>
